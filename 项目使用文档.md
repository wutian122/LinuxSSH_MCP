# Linux SSH MCP 项目使用文档

本文档详细介绍 Linux SSH MCP 提供的 14 个工具的使用方法、参数说明及示例。

## 1. 凭据管理

### `auth_store_credentials`

将 SSH 连接所需的密码或私钥路径安全存储到系统 keyring 中，后续调用其他工具时可自动获取，无需每次传入敏感信息。

**参数：**
- `host` (str): 目标主机地址（IP或域名）
- `username` (str): SSH 用户名
- `password` (str, 可选): SSH 密码
- `private_key_path` (str, 可选): 私钥文件绝对路径

> **注意**：必须至少提供 `password` 或 `private_key_path` 其中之一。

**示例：**
```json
// 存储密码
{
  "host": "192.168.1.100",
  "username": "root",
  "password": "my_secure_password"
}

// 存储私钥路径
{
  "host": "192.168.1.101",
  "username": "deploy",
  "private_key_path": "/home/user/.ssh/id_rsa"
}
```

---

## 2. 命令执行

### `ssh_execute`

在远程主机上执行单条命令。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `command` (str): 要执行的命令
- `port` (int, 默认 22): SSH 端口
- `token_mode` (str, 默认 "full"): 输出处理模式 ("full" | "filter" | "truncate")
- `filter_pattern` (str, 可选): 当 token_mode="filter" 时的正则过滤模式
- `max_tokens` (int, 可选): 当 token_mode="truncate" 时的最大 Token 数
- `use_cache` (bool, 默认 True): 是否使用缓存

**示例：**
```json
{
  "host": "192.168.1.100",
  "username": "root",
  "command": "ls -la /var/log"
}
```

### `ssh_execute_batch`

批量执行多条命令（顺序执行）。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `commands` (list[str]): 命令列表
- ...其他参数同 ssh_execute

**示例：**
```json
{
  "host": "192.168.1.100",
  "username": "root",
  "commands": [
    "uptime",
    "free -h",
    "df -h"
  ]
}
```

### `ssh_execute_script`

执行 Shell 脚本内容。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `script` (str): 脚本内容
- `shell` (str, 默认 "/bin/bash"): 解释器路径
- ...其他参数同 ssh_execute

**示例：**
```json
{
  "host": "192.168.1.100",
  "username": "root",
  "script": "for i in {1..5}; do echo \"Count: $i\"; done",
  "shell": "/bin/bash"
}
```

### `ssh_system_info`

获取远程主机的系统信息（主机名、内核、运行时间、负载等）。结果默认会被缓存。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `force_refresh` (bool, 默认 False): 是否强制刷新缓存

### `ssh_search_content`

在远程主机上使用 `grep -r` 搜索文件内容。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `query` (str): 搜索关键词或正则
- `path` (str): 搜索路径
- `token_mode` (str, 默认 "truncate"): 输出模式

### `ssh_health_check`

快速检查 SSH 连接是否健康。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名

---

## 3. 文件传输

### `file_upload`

上传本地文件到远程主机。支持 MD5 校验。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `local_path` (str): 本地文件路径
- `remote_path` (str): 远程目标路径
- `verify_md5` (bool, 默认 True): 是否校验文件完整性
- `resume` (bool, 默认 False): 是否断点续传

**示例：**
```json
{
  "host": "192.168.1.100",
  "username": "root",
  "local_path": "C:/data/config.json",
  "remote_path": "/etc/app/config.json"
}
```

### `file_download`

从远程主机下载文件到本地。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `remote_path` (str): 远程源文件路径
- `local_path` (str): 本地保存路径
- `verify_md5` (bool, 默认 True): 是否校验文件完整性

### `file_info`

获取远程文件的详细信息（大小、权限、修改时间、所有者）。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `path` (str): 远程文件路径

---

## 4. 目录管理

### `dir_list`

列出远程目录内容，支持分页和正则过滤。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `path` (str): 目录路径
- `page` (int, 默认 1): 页码
- `page_size` (int, 默认 20): 每页数量
- `filter_pattern` (str, 可选): 文件名过滤正则

**示例：**
```json
{
  "host": "192.168.1.100",
  "username": "root",
  "path": "/var/log",
  "filter_pattern": "\\.log$"
}
```

### `dir_interactive`

开启交互式会话，支持保持工作目录状态（如 `cd` 后执行命令）。

**参数：**
- `host` (str): 目标主机
- `username` (str): 用户名
- `command` (str): 执行的命令
- `session_id` (str, 可选): 会话 ID，用于复用会话
- `close_session` (bool, 默认 False): 是否在执行后关闭会话

**返回值：**
包含 `session_id`，后续调用可传入此 ID 以保持上下文。

---

## 5. 缓存管理

### `ssh_session_info`

查看当前 MCP 服务的缓存统计信息。

**返回值：**
- `maxsize`: 最大缓存容量
- `currsize`: 当前缓存条目数
- `keys`: 当前缓存的所有键列表

### `ssh_clear_cache`

清理缓存。

**参数：**
- `keys` (list[str], 可选): 指定清理的键列表
- `tag` (str, 可选): 清理指定标签的缓存
- `category` (str, 可选): 清理指定类别（static/dynamic）的缓存

---

## 安全机制

为了防止误操作，工具内置了安全校验机制：

1. **黑名单拦截**：以下命令会被直接拦截并报错：
   - `rm -rf /`
   - `mkfs` (格式化)
   - `dd if=` (磁盘写入)
   - `:(){ :|:& };:` (Fork 炸弹)
   - `shutdown` / `reboot`

2. **危险警告**：以下命令会执行，但在返回结果中附带警告信息：
   - `rm`, `chmod`, `chown`
   - `apt-get`, `yum`, `dnf`
   - `systemctl`
   - `useradd`, `userdel`
   - `iptables`, `ufw`

## 常见错误代码

- `SSHConnectionError`: 连接失败（超时、拒绝、HostKey 不匹配）
- `CredentialError`: 凭据无效或未找到
- `CommandBlockedError`: 命令被安全策略拦截
- `CommandExecutionError`: 命令执行失败（非零退出码）
- `FileTransferError`: 文件传输失败或校验不通过
