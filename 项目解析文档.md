# Linux SSH MCP 项目架构解析文档

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────┐
│                  MCP 客户端                          │
│          (Claude Desktop / Claude Code)              │
└──────────────────────┬──────────────────────────────┘
                       │ stdio (JSON-RPC)
┌──────────────────────▼──────────────────────────────┐
│                mcp_server.py                         │
│           MCP 协议层 (14个工具接口)                   │
│         TypedDict 强类型返回值                        │
├─────────┬─────────┬──────────┬───────────────────────┤
│ ssh_    │ file_   │ dir_     │ auth_                 │
│ manager │ transfer│ manager  │ manager               │
│         │ manager │          │                       │
├─────────┴────┬────┴──────────┴───────────────────────┤
│              │                                       │
│   security.py ◄── 命令安全校验（拦截/警告/白名单）     │
│              │                                       │
│   connection_pool.py ◄── 连接池                      │
│   ├── 后台清理任务 (30秒间隔)                         │
│   ├── 请求合并 (防惊群)                               │
│   ├── HostKey索引 (O(1)查找)                         │
│   └── 信号量并发控制                                  │
│              │                                       │
│   cache_manager.py ◄── TTL+LRU 缓存                 │
│              │                                       │
│   token_optimizer.py ◄── Token 优化                  │
│              │                                       │
│   exceptions.py ◄── 6级结构化异常                     │
│   types.py ◄── TypedDict 类型定义                    │
│   settings.py ◄── Pydantic 配置                      │
└──────────────┴───────────────────────────────────────┘
```

## 2. 核心模块解析

### 2.1 MCP协议层 (`mcp_server.py`)

**职责：** MCP 工具注册与请求分发，是整个系统的入口层。

- 使用 `FastMCP` 注册 14 个工具函数
- 通过 `@asynccontextmanager` 管理服务生命周期（初始化连接池、缓存等）
- 所有工具函数返回 `TypedDict` 强类型（如 `SSHCommandResultDict`、`TransferResultDict`）
- 通过 stdio 传输层与 MCP 客户端通信

**生命周期管理：**
```
启动 → 创建 Settings → 创建 ConnectionPool → 创建 CacheManager
     → 创建 SSHManager → 注册14个工具 → 等待请求
关闭 → pool.close_all() → 清理所有连接
```

### 2.2 SSH命令执行核心 (`ssh_manager.py`)

**职责：** SSH 命令执行、脚本执行、系统信息采集。

- 依赖注入 `CommandSecurityValidator`，解耦安全校验逻辑
- 支持三种 Token 模式：`full`（全量）、`filter`（正则过滤）、`truncate`（截断）
- 集成缓存系统，静态命令（hostname、uname等）长期缓存
- Google Style 文档注释，所有方法有完整参数说明

**核心流程：**
```
execute_command()
  → security.validate_command()  # 安全校验
  → cache.get()                   # 缓存命中检查
  → pool.acquire_connection()     # 获取连接
  → conn.run(command)             # 执行命令
  → token_optimizer.optimize()    # Token优化
  → cache.set()                   # 写入缓存
  → 返回 SSHCommandResult
```

### 2.3 连接池 (`connection_pool.py`)

**职责：** 异步 SSH 连接的池化管理，是性能优化的核心。

**数据结构：**
```python
_connections: dict[PoolKey, deque[_PooledConnection]]  # 主池
_host_index: dict[HostKey, set[PoolKey]]               # 主机索引
_semaphores: dict[HostKey, asyncio.Semaphore]           # 并发控制
_pending_connects: dict[PoolKey, asyncio.Future]        # 请求合并
```

**三大核心机制：**

1. **后台清理任务**：每30秒执行一次 `_cleanup_all_idle()`，扫描所有池化连接，清理超过 TTL 的空闲连接和已死连接。替代原来每次请求时的同步清理，减少关键路径延迟。

2. **请求合并（Request Coalescing）**：当多个请求同时需要连接到同一 `PoolKey` 时，通过 `asyncio.Future` 只创建一个实际连接，其余请求等待复用，防止惊群效应。

3. **HostKey 索引**：维护 `HostKey → Set[PoolKey]` 的映射，支持 O(1) 的主机级查询，便于批量操作同一主机的所有连接。

**连接获取流程：**
```
acquire_connection()
  → _ensure_cleanup_started()     # 懒启动后台清理
  → semaphore.acquire()           # 并发限制
  → _checkout()                   # 从池中取出连接
     → 检查连接是否死亡
     → 死亡连接丢弃，继续查找
  → 若池中无可用连接
     → _connect_or_join()         # 创建或合并请求
  → yield connection              # 使用连接
  → _checkin()                    # 归还连接到池中
  → semaphore.release()           # 释放信号量
```

### 2.4 安全校验 (`security.py`)

**职责：** 命令安全校验，独立于 ssh_manager 的单一职责模块。

**三级校验机制：**

| 级别 | 机制 | 匹配结果 |
|------|------|---------|
| 白名单 | 正则匹配 | 直接放行，跳过后续检查 |
| 黑名单 | 正则匹配 | 抛出 `CommandBlockedError` |
| 危险警告 | 正则匹配 | 放行，附加警告信息 |

**黑名单规则：** `rm -rf /`、`mkfs`、`dd if=`、fork炸弹、`shutdown`、`reboot`

**危险警告规则：** `rm`、`chmod`、`chown`、`apt-get`/`yum`、`systemctl`、`useradd`/`userdel`、`iptables`/`ufw`、`mount`/`umount`

### 2.5 异常体系 (`exceptions.py`)

**职责：** 提供结构化的错误处理，每种异常携带上下文信息。

```
SSHMCPError (基类)
├── SSHConnectionError     → host, port
├── CommandExecutionError   → command, exit_status, stderr
├── CommandBlockedError     → command, reason
├── FileTransferError       → local_path, remote_path
├── SessionError            → session_id
└── CredentialError         → host, username
```

所有异常都支持 `to_error_dict()` 方法，返回统一的 `{"error_type", "message", "details"}` 结构。

### 2.6 类型系统 (`types.py`)

**职责：** 集中定义所有 MCP 工具的返回值类型。

使用 `TypedDict` 替代 `dict[str, Any]`，提供编译期类型检查：

| TypedDict | 使用场景 |
|-----------|---------|
| `SSHCommandResultDict` | ssh_execute 返回值 |
| `TransferResultDict` | file_upload/download 返回值 |
| `FileInfoResultDict` | file_info 返回值 |
| `DirListResultDict` | dir_list 返回值 |
| `InteractiveResultDict` | dir_interactive 返回值 |
| `SystemInfoResultDict` | ssh_system_info 返回值 |
| `CacheStatsDict` | 缓存统计信息 |
| `SessionInfoResultDict` | ssh_session_info 返回值 |
| `CacheClearResultDict` | ssh_clear_cache 返回值 |
| `SSHAuthResultDict` | auth_store_credentials 返回值 |
| `SSHHealthCheckResultDict` | ssh_health_check 返回值 |

### 2.7 缓存管理 (`cache_manager.py`)

**职责：** TTL + LRU 双策略缓存。

- 静态命令（hostname、uname等）使用长 TTL（300-3600秒）
- 动态命令（ls、ps等）使用短 TTL（30-120秒）
- 最大缓存容量 128 条，LRU 淘汰最久未使用的条目
- 缓存键基于 `host:port:command` 三元组

### 2.8 Token优化器 (`token_optimizer.py`)

**职责：** 优化 SSH 命令输出的 Token 消耗。

| 模式 | 说明 |
|------|------|
| `full` | 返回完整输出 |
| `filter` | 使用正则表达式过滤输出行 |
| `truncate` | 按最大 Token 数截断输出 |

## 3. 配置系统

使用 Pydantic Settings v2，支持三层配置优先级：

```
环境变量 (SSH_MCP_*) > .env 文件 > 默认值
```

配置文件优先查找 `ssh_mcp_config.json`，支持预定义主机的凭据和连接参数。

## 4. 代码质量保障

| 工具 | 配置 | 说明 |
|------|------|------|
| mypy | `strict = true` | 严格类型检查 |
| ruff | E/W/F/I/B/C4/UP/N/SIM/RUF | 10类规则检查 |
| pytest | asyncio_mode = auto | 异步测试自动检测 |
| pytest-mock | mocker fixture | Mock/Patch 支持 |

## 5. 测试覆盖

项目包含 76+ 个测试用例，覆盖核心模块：

| 测试文件 | 测试数 | 覆盖模块 |
|---------|--------|---------|
| test_connection_pool.py | 34 | 连接复用/并发/清理/合并/索引/异常 |
| test_security.py | 27 | 黑名单/警告/白名单/脚本/边界 |
| test_exceptions.py | 15 | 异常层次/序列化/属性 |
| test_ssh_manager.py | 3 | 缓存/过滤/系统信息 |
| test_auth_manager.py | - | 凭据存取 |
| test_cache_manager.py | - | 缓存命中/过期 |
| 其他 | - | 目录管理/文件传输/MCP协议 |
