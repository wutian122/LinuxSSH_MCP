# 项目解析文档（SSH-MCP-001）

## 1. 项目定位

该项目提供 MCP Server（stdio 传输），将 SSH 远程运维能力封装为一组工具供 MCP 客户端调用。

## 2. 技术栈与依赖

- asyncssh：SSH/SFTP 通道与远程命令执行
- mcp：FastMCP 工具注册与协议层
- pydantic-settings：配置加载与校验
- keyring：安全保存密码/私钥路径
- loguru：日志
- pytest/ruff/mypy：测试与静态检查

依赖清单见：[pyproject.toml](file:///f:/claude%20code/python-use/%E9%A1%B9%E7%9B%AE/LinuxSSH_MCP%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%B7%A5%E5%85%B7_SSH-MCP-001/pyproject.toml)

## 3. 目录结构

- linux_ssh_mcp/
  - settings.py：配置定义
  - config_manager.py：加载 json/.env/环境变量
  - logger.py：日志初始化
  - auth_manager.py：keyring 凭据存取
  - token_optimizer.py：输出过滤/截断/Token 估算
  - connection_pool.py：连接池（并发、复用、空闲清理、租用连接）
  - cache_manager.py：TTL+LRU 缓存
  - ssh_manager.py：命令执行工具集合
  - file_transfer_manager.py：文件上传/下载/信息
  - directory_manager.py：目录列表分页+过滤、交互会话
  - mcp_server.py：FastMCP 服务与工具注册
- main.py：启动入口（stdio transport）
- tests/：mock 单元测试

## 4. 分层与依赖关系

### 4.1 基础设施层

- settings/config/logger/auth/token

### 4.2 连接层

- ConnectionPool 统一管理 SSH 连接

### 4.3 业务逻辑层

- CacheManager：为“可缓存命令”提供结果缓存
- SSHManager：依赖 ConnectionPool + CacheManager + TokenOptimizer
- FileTransferManager：依赖 ConnectionPool，通过 SFTP 进行传输
- DirectoryManager：依赖 ConnectionPool，提供 listdir 与交互式会话

### 4.4 协议层

- mcp_server.py：创建 FastMCP server，注册 14 个工具，统一处理凭据来源（参数优先，否则从 keyring 获取），并在 lifespan 中做资源回收。

## 5. 关键设计点

1. 缓存策略
   - 对明显写操作/重定向等命令默认不缓存
   - static/dynamic 分层 TTL

2. Token 控制
   - full：全量输出
   - filter：按正则保留关键信息
   - truncate：按 Token 上限截断

3. 连接复用与并发控制
   - 同主机并发上限通过 semaphore
   - 同 host/port/username 连接池复用
   - 支持 lease_connection 给交互会话持有连接

4. 优雅关闭
   - MCP lifespan 退出时先关闭交互会话，再关闭连接池

